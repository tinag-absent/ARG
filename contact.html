<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>お問い合わせ | 東亜先端研究株式会社</title>
  <meta name="description" content="東亜先端研究株式会社へのお問い合わせページです。" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="container">
      <h1 class="logo">Toa Advanced Research Inc.</h1>
      <nav class="nav">
        <a href="index.html#about">企業情報</a>
        <a href="index.html#services">事業内容</a>
        <a href="index.html#research">研究姿勢</a>
        <a href="contact.html">お問い合わせ</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h3>お問い合わせ</h3>
        <p>当社業務に関するお問い合わせは、下記フォームよりご連絡ください。</p>

        <form id="contactForm" class="contact-form">
          <div class="form-group">
            <label>お名前</label>
            <input id="name" type="text" required />
          </div>

          <div class="form-group">
            <label>お問い合わせ内容</label>
            <textarea id="message" rows="6" required></textarea>
          </div>

          <button type="submit">送信</button>
        </form>

        <p class="note">※ 研究内容の詳細についてはお答えできない場合があります。</p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; Toa Advanced Research Inc. All Rights Reserved.</p>
    </div>
  </footer>

<script>
/* =========================================================
   基本時間計測
========================================================= */
const pageLoadedAt = Date.now();
let firstTypedAt = null;

/* =========================================================
   DOM
========================================================= */
const form = document.getElementById("contactForm");
const nameEl = document.getElementById("name");
const messageEl = document.getElementById("message");

/* =========================================================
   入力開始・間隔計測（誤爆防止）
========================================================= */
let lastInputAt = null;
const intervals = [];

[nameEl, messageEl].forEach(el => {
  el.addEventListener("input", () => {
    const now = Date.now();
    if (!firstTypedAt) firstTypedAt = now;
    if (lastInputAt) intervals.push(now - lastInputAt);
    lastInputAt = now;
  });
});

/* =========================================================
   誤爆防止パラメータ
========================================================= */
const MIN_ALPHA_RATIO = 0.35;
const MIN_WORDS = 8;
const MAX_REPEAT_RATIO = 0.35;
const MIN_INTERVAL_STD = 120;
const DENY_WORDS = ["test", "debug", "sample", "lorem"];

/* =========================================================
   段階累積（localStorage）
========================================================= */
const PROGRESS_KEY = "progressLevel";
const PROGRESS_TS  = "progressTimestamp";
const PROGRESS_TTL = 72 * 60 * 60 * 1000;

function getProgress() {
  const lvl = parseInt(localStorage.getItem(PROGRESS_KEY) || "0", 10);
  const ts  = parseInt(localStorage.getItem(PROGRESS_TS) || "0", 10);
  if (!ts || Date.now() - ts > PROGRESS_TTL) {
    clearProgress();
    return 0;
  }
  return lvl;
}

function setProgress(lvl) {
  localStorage.setItem(PROGRESS_KEY, String(lvl));
  localStorage.setItem(PROGRESS_TS, String(Date.now()));
}

function clearProgress() {
  localStorage.removeItem(PROGRESS_KEY);
  localStorage.removeItem(PROGRESS_TS);
}

function sessionOnce(level) {
  const k = `session:L${level}`;
  if (sessionStorage.getItem(k)) return false;
  sessionStorage.setItem(k, "1");
  return true;
}

/* =========================================================
   段階定義（順序進行）
========================================================= */
const STAGES = [
  {
    level: 1,
    minStay: 8000,
    minType: 3000,
    minChars: 30,
    parts: ["shore"],
    redirect: null
  },
  {
    level: 2,
    minStay: 12000,
    minType: 5000,
    minChars: 50,
    parts: ["shore", "variance"],
    redirect: null
  },
  {
    level: 3,
    minStay: 20000,
    minType: 8000,
    minChars: 80,
    parts: ["shore", "variance", "silent"],
    redirect: "/internal/core.html"
  }
];

/* =========================================================
   ユーティリティ（誤爆防止）
========================================================= */
function stddev(arr) {
  if (arr.length < 4) return 0;
  const m = arr.reduce((a,b)=>a+b,0)/arr.length;
  return Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/arr.length);
}

function qualityOK(text) {
  const letters = (text.match(/[a-z]/gi) || []).length;
  const alphaRatio = letters / Math.max(text.length, 1);

  const words = (text.match(/\b[a-z]{3,}\b/g) || []);
  const freq = words.reduce((m,w)=> (m[w]=(m[w]||0)+1, m), {});
  const maxRepeat = Math.max(0, ...Object.values(freq));
  const repeatRatio = maxRepeat / Math.max(words.length,1);

  const hasDeny = DENY_WORDS.some(w => text.includes(w));
  const intervalStd = stddev(intervals);

  return (
    alphaRatio >= MIN_ALPHA_RATIO &&
    words.length >= MIN_WORDS &&
    repeatRatio <= MAX_REPEAT_RATIO &&
    intervalStd >= MIN_INTERVAL_STD &&
    !hasDeny
  );
}

/* =========================================================
   送信処理（段階累積＋誤爆防止）
========================================================= */
form.addEventListener("submit", e => {
  e.preventDefault();

  const now = Date.now();
  const stayMs = now - pageLoadedAt;
  const typeMs = firstTypedAt ? now - firstTypedAt : 0;

  const combinedRaw = `${nameEl.value} ${messageEl.value}`;
  const charCount = combinedRaw.replace(/\s+/g, "").length;
  const text = combinedRaw.toLowerCase();

  const current = getProgress();
  const stage = STAGES.find(s => s.level === current + 1);
  if (!stage) return normal();

  const passed =
    stayMs >= stage.minStay &&
    typeMs >= stage.minType &&
    charCount >= stage.minChars &&
    stage.parts.every(p => text.includes(p));

  if (
    passed &&
    sessionOnce(stage.level) &&
    (stage.level === 1 || qualityOK(text))
  ) {
    setProgress(stage.level);
    if (stage.redirect) {
      triggerAnomaly(stage.level).then(() => {
        location.href = stage.redirect;
      });
    } else {
      normal();
    }
  } else {
    normal();
  }
});

function normal() {
  alert("お問い合わせを受け付けました。");
  form.reset();
}

/* =========================================================
   異常UI
========================================================= */
function triggerAnomaly(level) {
  return new Promise(resolve => {
    const o = document.createElement("div");
    o.className = "anomaly-overlay";
    o.innerHTML = `
      <div class="anomaly-box">
        <p>VERIFYING REQUEST</p>
        <p class="small">ACCESS LEVEL L${level}</p>
      </div>`;
    document.body.appendChild(o);
    setTimeout(()=>o.classList.add("visible"),50);
    setTimeout(()=>o.classList.remove("visible"),900);
    setTimeout(()=>{o.remove(); resolve();},1200);
  });
}
</script>

<style>
.contact-form { max-width:640px; margin-top:32px }
.form-group { margin-bottom:20px }
label { display:block; margin-bottom:6px; font-size:14px }
input, textarea {
  width:100%; padding:12px;
  border:1px solid #d1d5db; font-size:14px
}
button {
  padding:12px 32px;
  border:1px solid #374151;
  background:#fff; cursor:pointer;
  color:black;
  border-radius:3px;
}
.anomaly-overlay {
  position:fixed; inset:0;
  background:rgba(255,255,255,.92);
  display:flex; align-items:center; justify-content:center;
  opacity:0; transition:.2s; z-index:9999
}
.anomaly-overlay.visible { opacity:1 }
.anomaly-box {
  text-align:center;
  font-family:Courier, monospace;
  letter-spacing:.12em
}
.anomaly-box .small { font-size:11px; color:#6b7280 }
</style>
</body>
</html>
